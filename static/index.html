<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Agent Web UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Phone Agent 任务管理</h1>
        
        <!-- 任务列表 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">任务列表</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="openCreateModal()">创建新任务</button>
                <div id="tasksList">
                    <!-- 任务列表将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>

        <!-- 创建/编辑任务模态框 -->
        <div class="modal fade" id="taskModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="taskModalLabel">创建任务</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="taskForm">
                            <input type="hidden" id="taskId">
                            <div class="mb-3">
                                <label for="taskName" class="form-label">任务名称</label>
                                <input type="text" class="form-control" id="taskName" required>
                            </div>
                            <div class="mb-3">
                                <label for="taskDescription" class="form-label">任务描述</label>
                                <textarea class="form-control" id="taskDescription" rows="3" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="baseUrl" class="form-label">Base URL</label>
                                        <input type="text" class="form-control" id="baseUrl" value="https://open.bigmodel.cn/api/paas/v4">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="modelName" class="form-label">模型名称</label>
                                        <input type="text" class="form-control" id="modelName" value="autoglm-phone">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="apiKey" class="form-label">API Key</label>
                                        <input type="password" class="form-control" id="apiKey" value="EMPTY">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deviceId" class="form-label">设备ID</label>
                                        <input type="text" class="form-control" id="deviceId">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="maxSteps" class="form-label">最大步骤数</label>
                                        <input type="number" class="form-control" id="maxSteps" value="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="language" class="form-label">语言</label>
                                        <select class="form-control" id="language">
                                            <option value="cn">中文</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveTask()">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 执行记录 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">执行记录</h5>
            </div>
            <div class="card-body">
                <div id="executionsList">
                    <!-- 执行记录将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000';
        
        // 页面加载时获取任务列表
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
        });
        
        // 获取任务列表
        async function loadTasks() {
            try {
                const response = await axios.get(`${API_BASE}/tasks`);
                const tasks = response.data;
                const tasksList = document.getElementById('tasksList');
                
                if (tasks.length === 0) {
                    tasksList.innerHTML = '<p>暂无任务</p>';
                    return;
                }
                
                let html = '<div class="row">';
                tasks.forEach(task => {
                    html += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${task.name}</h5>
                                    <p class="card-text">${task.description}</p>
                                    <p class="text-muted small">
                                        模型: ${task.model}<br>
                                        创建时间: ${new Date(task.created_at).toLocaleString()}
                                    </p>
                                    <button class="btn btn-sm btn-primary" onclick="editTask('${task.id}')">编辑</button>
                                    <button class="btn btn-sm btn-success" onclick="executeTask('${task.id}')">运行</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTask('${task.id}')">删除</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                tasksList.innerHTML = html;
            } catch (error) {
                console.error('获取任务列表失败:', error);
                document.getElementById('tasksList').innerHTML = '<p class="text-danger">获取任务列表失败</p>';
            }
        }
        
        // 打开创建任务模态框
        function openCreateModal() {
            document.getElementById('taskModalLabel').textContent = '创建任务';
            document.getElementById('taskId').value = '';
            document.getElementById('taskForm').reset();
            document.getElementById('baseUrl').value = 'https://open.bigmodel.cn/api/paas/v4';
            document.getElementById('modelName').value = 'autoglm-phone';
            document.getElementById('apiKey').value = 'EMPTY';
            document.getElementById('maxSteps').value = '100';
            document.getElementById('language').value = 'cn';
        }
        
        // 编辑任务
        async function editTask(taskId) {
            try {
                const response = await axios.get(`${API_BASE}/tasks/${taskId}`);
                const task = response.data;
                
                document.getElementById('taskModalLabel').textContent = '编辑任务';
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDescription').value = task.description;
                document.getElementById('baseUrl').value = task.base_url;
                document.getElementById('modelName').value = task.model;
                document.getElementById('apiKey').value = task.apikey;
                document.getElementById('deviceId').value = task.device_id || '';
                document.getElementById('maxSteps').value = task.max_steps;
                document.getElementById('language').value = task.lang;
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('taskModal'));
                modal.show();
            } catch (error) {
                console.error('获取任务信息失败:', error);
                alert('获取任务信息失败');
            }
        }
        
        // 保存任务（创建或更新）
        async function saveTask() {
            try {
                const taskId = document.getElementById('taskId').value;
                const taskData = {
                    name: document.getElementById('taskName').value,
                    description: document.getElementById('taskDescription').value,
                    base_url: document.getElementById('baseUrl').value,
                    model: document.getElementById('modelName').value,
                    apikey: document.getElementById('apiKey').value,
                    device_id: document.getElementById('deviceId').value || null,
                    max_steps: parseInt(document.getElementById('maxSteps').value),
                    lang: document.getElementById('language').value
                };
                
                if (taskId) {
                    // 更新任务
                    await axios.put(`${API_BASE}/tasks/${taskId}`, taskData);
                } else {
                    // 创建任务
                    await axios.post(`${API_BASE}/tasks`, taskData);
                }
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                modal.hide();
                
                // 重新加载任务列表
                loadTasks();
                
                alert('任务保存成功');
            } catch (error) {
                console.error('保存任务失败:', error);
                alert('保存任务失败');
            }
        }
        
        // 删除任务
        async function deleteTask(taskId) {
            if (!confirm('确定要删除这个任务吗？')) {
                return;
            }
            
            try {
                await axios.delete(`${API_BASE}/tasks/${taskId}`);
                loadTasks();
                alert('任务已删除');
            } catch (error) {
                console.error('删除任务失败:', error);
                alert('删除任务失败');
            }
        }
        
        // 执行任务
        async function executeTask(taskId) {
            try {
                const response = await axios.post(`${API_BASE}/tasks/${taskId}/execute`);
                const execution = response.data;
                alert(`任务开始执行 (执行ID: ${execution.execution_id})`);
                
                // 可以在这里添加轮询执行状态的逻辑
            } catch (error) {
                console.error('执行任务失败:', error);
                alert('执行任务失败');
            }
        }
    </script>
</body>
</html>